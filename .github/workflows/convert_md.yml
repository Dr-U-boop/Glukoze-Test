name: Convert MD to PDF with Diagrams

on:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 1. Устанавливаем Node.js (нужен для Mermaid)
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # 2. Устанавливаем Mermaid CLI для рендеринга диаграмм
      - name: Install Mermaid CLI
        run: npm install -g @mermaid-js/mermaid-cli

      # 3. Устанавливаем Pandoc и LaTeX (для создания PDF)
      - name: Install Pandoc and TeX Live
        run: |
          sudo apt-get update
          sudo apt-get install -y pandoc texlive-xetex texlive-fonts-recommended librsvg2-bin
# 1. Создаем файл настроек для Puppeteer
      - name: Create Puppeteer Config
        run: |
          echo '{"args": ["--no-sandbox", "--disable-setuid-sandbox"]}' > puppeteer-config.json

  
      # 4. Рендерим диаграммы Mermaid в картинки внутри MD
      # Этот шаг ищет блоки mermaid и заменяет их на изображения перед конвертацией
      - name: Render Mermaid diagrams
        run: |
          # Мы используем mmdc для конвертации. 
          # Если файлов много, можно запустить цикл или использовать специальные плагины.
          # Для одного файла:
          mmdc -p puppeteer-config.json -i project_report.md -o project_report_diag.md

      # 5. Конвертируем финальный файл в PDF через Pandoc
      - name: Convert MD to PDF
        run: |
          pandoc project_report_diag.md -o output/manual.pdf --pdf-engine=xelatex

      - name: Upload result
        uses: actions/upload-artifact@v4
        with:
          name: final-pdf
          path: output/manual.pdf
